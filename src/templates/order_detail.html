{% extends "base.html" %}
{% block title %}Order #{{ order.id }} • SCM Pro{% endblock %}

{% macro status_badge(status) %}
  {% set s = (status or "")|lower %}
  {% if s == "pending" %}
    <span class="badge rounded-pill text-bg-warning">Pending</span>
  {% elif s == "processing" %}
    <span class="badge rounded-pill text-bg-primary">Processing</span>
  {% elif s == "shipped" %}
    <span class="badge rounded-pill text-bg-info">Shipped</span>
  {% elif s == "delivered" %}
    <span class="badge rounded-pill text-bg-success">Delivered</span>
  {% elif s == "cancelled" %}
    <span class="badge rounded-pill text-bg-danger">Cancelled</span>
  {% else %}
    <span class="badge rounded-pill text-bg-secondary">{{ status or "—" }}</span>
  {% endif %}
{% endmacro %}

{% block content %}
<div class="erp-pagewrap">

  <!-- Header -->
  <div class="erp-pagehead">
    <div>
      <div class="erp-breadcrumbs">
        <span class="text-muted">Orders</span>
        <span class="mx-2 text-muted">/</span>
        <span>#{{ order.id }}</span>
      </div>

      <h1 class="erp-title mb-0">Order #{{ order.id }}</h1>

      <div class="erp-subtitle d-flex flex-wrap align-items-center gap-2">
        <span>
          Placed:
          <span class="fw-semibold">
            {{ order.order_date.strftime("%Y-%m-%d %H:%M") if order.order_date else "—" }}
          </span>
        </span>
        <span>{{ status_badge(order.status) }}</span>

        <span class="erp-chip">
          <i class="bi bi-receipt me-1"></i>
          Items:
          <span class="fw-semibold ms-1">{{ order.items|length if order.items else 0 }}</span>
        </span>

        <span class="erp-chip">
          <i class="bi bi-currency-dollar me-1"></i>
          Total:
          <span class="fw-semibold ms-1">{{ "%.2f"|format(order.total_amount or 0) }}</span>
        </span>
      </div>
    </div>

    <div class="erp-actions d-flex flex-wrap gap-2 justify-content-end">
      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('frontend.view_orders') }}">
        <i class="bi bi-chevron-left me-1"></i>Back to Orders
      </a>

      <button class="btn btn-sm btn-outline-secondary" type="button" onclick="window.print()">
        <i class="bi bi-printer me-1"></i>Print
      </button>

      <button class="btn btn-sm btn-outline-secondary"
              type="button"
              onclick="navigator.clipboard && navigator.clipboard.writeText('ORDER-{{ order.id }}')">
        <i class="bi bi-clipboard me-1"></i>Copy ID
      </button>
    </div>
  </div>

  <div class="row g-3 mt-2">

    <!-- Customer -->
    <div class="col-12 col-xl-5">
      <div class="erp-card">
        <div class="erp-cardhead">
          <div class="erp-cardtitle"><i class="bi bi-person-badge me-2"></i>Customer</div>
        </div>
        <div class="erp-cardbody">

          <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
            <div>
              <div class="text-muted small">Name</div>
              <div class="fw-semibold">
                {{ order.customer_name or (order.placer.username if order.placer else "N/A") }}
              </div>
            </div>
            <div class="text-end">
              <div class="text-muted small">Order ID</div>
              <div class="fw-semibold">#{{ order.id }}</div>
            </div>
          </div>

          <div class="mb-3">
            <div class="text-muted small d-flex align-items-center gap-2">
              <i class="bi bi-envelope"></i><span>Email</span>
            </div>
            <div class="fw-semibold d-flex flex-wrap align-items-center gap-2">
              <span>{{ order.customer_email or (order.placer.email if order.placer else "N/A") }}</span>
              {% set email_to_copy = order.customer_email or (order.placer.email if order.placer else "") %}
              {% if email_to_copy %}
                <button class="btn btn-sm btn-outline-secondary"
                        type="button"
                        onclick="navigator.clipboard && navigator.clipboard.writeText('{{ email_to_copy }}')">
                  <i class="bi bi-clipboard"></i>
                </button>
              {% endif %}
            </div>
          </div>

          <div>
            <div class="text-muted small d-flex align-items-center gap-2">
              <i class="bi bi-geo-alt"></i><span>Shipping address</span>
            </div>
            <div class="fw-semibold">{{ order.shipping_address or "—" }}</div>
          </div>

        </div>
      </div>
    </div>

    <!-- Summary -->
    <div class="col-12 col-xl-7">
      <div class="erp-card">
        <div class="erp-cardhead d-flex align-items-center justify-content-between">
          <div>
            <div class="erp-cardtitle"><i class="bi bi-receipt me-2"></i>Summary</div>
            <div class="text-muted small">Progress + admin controls</div>
          </div>
          <div class="text-end">
            <div class="text-muted small">Total</div>
            <div class="fw-bold fs-5">{{ "%.2f"|format(order.total_amount or 0) }}</div>
          </div>
        </div>

        <div class="erp-cardbody">

          <div class="row g-3">
            <div class="col-6">
              <div class="text-muted small">Overall Status</div>
              <div class="fw-semibold">{{ status_badge(order.status) }}</div>
            </div>
            <div class="col-6">
              <div class="text-muted small">Items</div>
              <div class="fw-semibold">{{ order.items|length if order.items else 0 }}</div>
            </div>
          </div>

          <!-- Timeline (uses YOUR CSS: .erp-step / .dot / .label) -->
          <div class="erp-timeline">
            {% set current = (order.status or 'Pending') %}
            {% set rank = {'Pending': 1, 'Processing': 2, 'Shipped': 3, 'Delivered': 4, 'Cancelled': 0} %}
            {% set current_rank = rank.get(current, 1) %}

            {% for label in ['Pending','Processing','Shipped','Delivered'] %}
              {% set step_rank = rank.get(label, 1) %}
              {% set is_done = (current != 'Cancelled') and (current_rank > step_rank) %}
              {% set is_active = (current != 'Cancelled') and (current_rank == step_rank) %}

              <div class="erp-step {% if is_done %}done{% elif is_active %}active{% endif %}">
                <div class="dot"></div>
                <div class="label">{{ label }}</div>
              </div>
            {% endfor %}
          </div>

          {% if current == 'Cancelled' %}
            <div class="mt-2 text-muted small">
              <i class="bi bi-x-circle me-1"></i>This order is cancelled.
            </div>
          {% endif %}

          {% if current_user.is_authenticated and current_user.role == "admin" and order.status not in ["Delivered", "Cancelled"] %}
            <div class="erp-divider"></div>

            <form action="{{ url_for('frontend.update_order_status', order_id=order.id) }}"
                  method="POST"
                  class="d-flex flex-wrap gap-2 align-items-center">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

              <select name="status" class="form-select form-select-sm" style="width: auto;">
                <option value="Pending" {% if order.status == "Pending" %}selected{% endif %}>Pending</option>
                <option value="Processing" {% if order.status == "Processing" %}selected{% endif %}>Processing</option>
                <option value="Shipped" {% if order.status == "Shipped" %}selected{% endif %}>Shipped</option>
                <option value="Delivered" {% if order.status == "Delivered" %}selected{% endif %}>Delivered</option>
                <option value="Cancelled" {% if order.status == "Cancelled" %}selected{% endif %}>Cancelled</option>
              </select>

              <button type="submit" class="btn btn-sm btn-primary">
                <i class="bi bi-arrow-repeat me-1"></i>Update Order Status
              </button>

              <span class="text-muted small ms-1">
                (Locks when Delivered/Cancelled)
              </span>
            </form>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Items -->
    <div class="col-12">
      <div class="erp-card">
        <div class="erp-cardhead d-flex align-items-center justify-content-between">
          <div>
            <div class="erp-cardtitle"><i class="bi bi-list-check me-2"></i>Order items</div>
            <div class="text-muted small">Line items + supplier updates</div>
          </div>
          <div class="text-muted small">
            Subtotals calculated per line
          </div>
        </div>

        <div class="erp-cardbody">
          {% if order.items and order.items|length > 0 %}
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th class="text-nowrap">SKU</th>
                    <th class="text-nowrap">Qty</th>
                    <th class="text-nowrap">Price</th>
                    <th class="text-nowrap">Item Status</th>
                    <th class="text-nowrap text-end">Subtotal</th>
                    {% if current_user.is_authenticated and current_user.role == 'supplier' %}
                      <th class="text-nowrap">Actions</th>
                    {% endif %}
                  </tr>
                </thead>

                <tbody>
                  {% for item in order.items %}
                    {% set line_subtotal = (item.quantity or 0) * (item.price_at_purchase or 0) %}
                    <tr>
                      <td>
                        <div class="fw-semibold">
                          {{ item.product.name if item.product else "Product not found" }}
                        </div>
                        {% if item.product and item.product.supplier %}
                          <div class="small text-muted">
                            Supplier: {{ item.product.supplier.name }}
                          </div>
                        {% endif %}
                      </td>

                      <td class="text-muted">{{ item.product.sku if item.product else "—" }}</td>
                      <td class="fw-semibold">{{ item.quantity }}</td>
                      <td>{{ "%.2f"|format(item.price_at_purchase or 0) }}</td>
                      <td>{{ status_badge(item.status) }}</td>

                      <td class="text-end fw-semibold">
                        {{ "%.2f"|format(line_subtotal) }}
                      </td>

                      {% if current_user.is_authenticated and current_user.role == 'supplier' %}
                        <td>
                          {% if supplier_profile and item.product and item.product.supplier_id == supplier_profile.id %}
                            {% if item.status not in ["Delivered", "Cancelled"] %}
                              <form action="{{ url_for('frontend.update_supplier_order_item_status', item_id=item.id) }}"
                                    method="POST"
                                    class="d-flex flex-wrap gap-2 align-items-center">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="order_id" value="{{ order.id }}"/>

                                <select name="status" class="form-select form-select-sm" style="width: auto;">
                                  <option value="Pending" {% if item.status == "Pending" %}selected{% endif %}>Pending</option>
                                  <option value="Processing" {% if item.status == "Processing" %}selected{% endif %}>Processing</option>
                                  <option value="Shipped" {% if item.status == "Shipped" %}selected{% endif %}>Shipped</option>
                                  <option value="Delivered" {% if item.status == "Delivered" %}selected{% endif %}>Delivered</option>
                                  <option value="Cancelled" {% if item.status == "Cancelled" %}selected{% endif %}>Cancelled</option>
                                </select>

                                <button type="submit" class="btn btn-sm btn-primary">
                                  <i class="bi bi-check2-circle me-1"></i>Update
                                </button>
                              </form>
                            {% else %}
                              <span class="text-muted">—</span>
                            {% endif %}
                          {% else %}
                            <span class="text-muted">—</span>
                          {% endif %}
                        </td>
                      {% endif %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-muted">No items found for this order.</div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
